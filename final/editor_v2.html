<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Editor CSSX - Compilador Educativo</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/theme/material-darker.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/mode/simple.min.js"></script>
    <style>
        :root { --header-height: 45px; --toolbar-height: 45px; --console-height: 200px; }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', sans-serif; background: #1e1e1e; color: #d4d4d4; height: 100vh; display: flex; flex-direction: column; }
        .header, .toolbar { flex-shrink: 0; background: #252526; padding: 0 20px; height: var(--header-height); display: flex; align-items: center; border-bottom: 1px solid #3c3c3c; }
        .header { justify-content: space-between; }
        .toolbar { height: var(--toolbar-height); gap: 10px; }
        .main-container { display: grid; grid-template-columns: 1fr 1fr; flex-grow: 1; height: calc(100vh - var(--header-height) - var(--toolbar-height) - var(--console-height)); }
        .editor-panel, .preview-panel { display: flex; flex-direction: column; overflow: hidden; }
        .editor-panel { border-right: 1px solid #3c3c3c; }
        .panel-header { background: #2d2d30; padding: 8px 15px; border-bottom: 1px solid #3c3c3c; display: flex; justify-content: space-between; align-items: center; flex-shrink: 0; }
        .panel-title { font-size: 13px; font-weight: 500; }
        .CodeMirror { flex-grow: 1; height: 100%; font-family: 'Consolas', monospace; font-size: 14px; }
        .preview-frame { flex-grow: 1; border: none; background: white; }
        .console-panel { height: var(--console-height); display: flex; flex-direction: column; position: relative; background: #1e1e1e; border-top: 1px solid #3c3c3c; }
        #resizer { width: 100%; height: 5px; background: #3c3c3c; cursor: ns-resize; position: absolute; top: -2px; left: 0; z-index: 10; }
        .console-content { flex-grow: 1; padding: 10px; overflow-y: auto; font-size: 12px; font-family: 'Consolas', monospace; }
        .console-line { padding: 2px 0; border-bottom: 1px solid #2d2d30; word-wrap: break-word; }
        .console-line a { color: #4fc1ff; text-decoration: none; }
        .console-line a:hover { text-decoration: underline; }
        .console-line.success { color: #4ec9b0; } .console-line.error { color: #f48771; } .console-line.warning { color: #dcdcaa; } .console-line.info { color: #569cd6; }
        .btn { padding: 6px 15px; border: none; border-radius: 4px; cursor: pointer; font-size: 13px; font-weight: 500; transition: all 0.2s; }
        .btn-primary { background: #0e639c; color: white; } .btn-primary:hover { background: #1177bb; }
        .btn-secondary { background: #3c3c3c; color: #d4d4d4; } .btn-secondary:hover { background: #505050; }
        .btn-success { background: #2ea043; color: white; }
        .status-indicator { padding: 5px 12px; border-radius: 4px; font-size: 12px; }
        .status-indicator.connected { background: #2ea043; color: white; } .status-indicator.disconnected { background: #cf222e; color: white; }
    </style>
</head>
<body>
    <div class="header">
        <h1>üìù Editor CSSX</h1>
        <div id="connectionStatus" class="status-indicator disconnected">‚ö™ Desconectado</div>
    </div>
    <div class="toolbar">
        <button class="btn btn-primary" onclick="compileCode()">‚ñ∂Ô∏è Compilar</button>
        <button class="btn btn-secondary" onclick="clearEditor()">üóëÔ∏è Limpiar</button>
        <button class="btn btn-success" onclick="loadExample()">üìã Ejemplo</button>
        <button class="btn btn-primary" onclick="downloadHTML()" style="background: #0d7a3d;">üíæ Descargar HTML</button>
        <button class="btn btn-primary" onclick="downloadCSS()" style="background: #0d7a3d;">üíæ Descargar CSS</button>
        <div style="display: flex; align-items: center; font-size: 12px; color: #ffa500;">‚ö° Auto-compilaci√≥n activada</div>
    </div>
    <div id="mainContainer" class="main-container">
        <div class="editor-panel">
            <div class="panel-header"><div class="panel-title">üìÑ Editor CSSX</div></div>
        </div>
        <div class="preview-panel">
            <div class="panel-header" style="color: #333; border-color: #ddd;">üñºÔ∏è Vista Previa</div>
            <iframe id="previewFrame" class="preview-frame"></iframe>
        </div>
    </div>
    <div class="console-panel" id="consolePanel">
        <div id="resizer"></div>
        <div class="panel-header">
            <div class="panel-title">üí¨ Consola</div>
            <div>
                <button class="btn btn-secondary" style="padding: 4px 10px; font-size: 11px;" onclick="showAST()">Mostrar AST</button>
                <button class="btn btn-secondary" style="padding: 4px 10px; font-size: 11px;" onclick="clearConsole()">Limpiar</button>
            </div>
        </div>
        <div id="consoleContent" class="console-content"></div>
    </div>

    <script>
        const socket = io();
        const editorPanel = document.querySelector('.editor-panel');
        const previewFrame = document.getElementById('previewFrame');
        const consoleContent = document.getElementById('consoleContent');
        const connectionStatus = document.getElementById('connectionStatus');
        
        let editor;
        let isConnected = false;
        let compileTimeout = null;
        let lastCompiledHTML = '';
        let lastCompiledCSS = '';

        function defineCssxMode(properties) {
            const propertyRegex = new RegExp(`(?:${properties.join('|')})\\b`);
            CodeMirror.defineSimpleMode("cssx", {
                start: [
                    { regex: /\/\/.*/, token: "comment" },
                    { regex: /"(?:[^\\]|\\.)*?"/, token: "string" },
                    { regex: /@[\w\u00C0-\u017F-]+/, token: "variable-2" },
                    { regex: propertyRegex, token: "property" },
                    { regex: /(?:[a-zA-Z][\w-]*|#["\w-]*|\.["\w-]+)(?=\s*\{)/, token: "tag" },
                    { regex: /#[0-9a-fA-F]{3,8}\b/, token: "number" },
                    { regex: /-?\d+(?:\.\d+)?(?:px|em|rem|%|vh|vw|s)?\b/, token: "number" },
                    { regex: /=/, token: "operator" },
                    { regex: /\{/, indent: true, token: "bracket" },
                    { regex: /\}/, dedent: true, token: "bracket" },
                ]
            });
        }

        async function initializeEditor() {
            logToConsole('üöÄ Editor CSSX iniciado.', 'info');
            try {
                const response = await fetch('/get_cssx_properties');
                const data = await response.json();
                defineCssxMode(data.success ? data.properties : []);
            } catch (e) {
                logToConsole('‚ö†Ô∏è No se pudieron cargar las propiedades de CSSX para el resaltado.', 'warning');
                defineCssxMode([]);
            }

            editor = CodeMirror(editorPanel, {
                lineNumbers: true,
                mode: 'cssx',
                theme: 'material-darker',
                autofocus: true,
                value: "// Cargando c√≥digo inicial..."
            });

            editor.on('change', () => {
                if (compileTimeout) clearTimeout(compileTimeout);
                compileTimeout = setTimeout(compileCode, 800);
            });

            try {
                const initialCode = await fetch('/get_initial_code').then(res => res.json());
                if (initialCode.code) {
                    editor.setValue(initialCode.code);
                    logToConsole('üìÇ C√≥digo inicial cargado.', 'info');
                }
            } catch(e) {
                logToConsole('‚ö†Ô∏è No se pudo cargar el c√≥digo inicial.', 'warning');
            }
        }

        window.addEventListener('load', initializeEditor);

        socket.on('connect', () => {
            isConnected = true;
            connectionStatus.textContent = 'üü¢ Conectado';
            connectionStatus.className = 'status-indicator connected';
            if(editor) compileCode();
        });

        socket.on('disconnect', () => {
            isConnected = false;
            connectionStatus.textContent = 'üî¥ Desconectado';
            connectionStatus.className = 'status-indicator disconnected';
        });

        socket.on('compilation_result', (data) => {
            clearConsole();
            if (data.success) {
                logToConsole('‚úÖ Compilaci√≥n exitosa', 'success');
                lastCompiledHTML = data.html || '';
                lastCompiledCSS = data.css || '';
                if (data.warnings && data.warnings.length > 0) {
                    logToConsole(`‚ö†Ô∏è Se encontraron ${data.warnings.length} advertencia(s):`, 'warning');
                    data.warnings.forEach(w => logToConsole(formatDiagnostic(w), 'warning'));
                }
                if (data.html) updatePreview(data.html);
            } else {
                logToConsole('‚ùå Error en la compilaci√≥n', 'error');
                if (data.errors && data.errors.length > 0) {
                    data.errors.forEach(e => logToConsole(formatDiagnostic(e), 'error'));
                }
            }
        });

        function compileCode() {
            if (!isConnected || !editor) return;
            socket.emit('compile_cssx', { code: editor.getValue() });
        }

        function updatePreview(htmlContent) {
            const doc = previewFrame.contentDocument || previewFrame.contentWindow.document;
            doc.open();
            doc.write(htmlContent);
            doc.close();
        }

        function clearConsole() { consoleContent.innerHTML = ''; }
        function clearEditor() { if(editor) editor.setValue(''); }

        async function loadExample() {
            try {
                const response = await fetch('/get_example_code');
                const data = await response.json();
                if (data.success) {
                    editor.setValue(data.code);
                    logToConsole('üìã Ejemplo cargado en el editor.', 'success');
                } else {
                    logToConsole('‚ö†Ô∏è No se pudo cargar el archivo de ejemplo.', 'warning');
                }
            } catch (e) {
                logToConsole('‚ùå Error de red al cargar el ejemplo.', 'error');
            }
        }

        function downloadFile(content, fileName, mimeType) {
            if (!content) {
                logToConsole(`‚ö†Ô∏è No hay ${fileName.split('.')[1].toUpperCase()} generado para descargar.`, 'warning');
                return;
            }
            const blob = new Blob([content], { type: mimeType });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = fileName;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            logToConsole(`üíæ ${fileName} descargado exitosamente.`, 'success');
        }
        function downloadHTML() { downloadFile(lastCompiledHTML, 'index.html', 'text/html;charset=utf-8'); }
        function downloadCSS() { downloadFile(lastCompiledCSS, 'style.css', 'text/css;charset=utf-8'); }

        function formatDiagnostic(diag) {
            const msg = `[L${diag.line}, C${diag.col}] ${diag.code}: ${diag.message}`;
            return diag.doc_url ? `${msg} <a href="/${diag.doc_url}" target="_blank" title="Ver documentaci√≥n">[docs]</a>` : msg;
        }

        function logToConsole(message, type = 'info') {
            const time = new Date().toLocaleTimeString();
            const line = document.createElement('div');
            line.className = `console-line ${type}`;
            line.innerHTML = `[${time}] ${message}`;
            consoleContent.appendChild(line);
            consoleContent.scrollTop = consoleContent.scrollHeight;
        }
        
        function logPreformatted(text, type = 'info') {
            const time = new Date().toLocaleTimeString();
            const pre = document.createElement('pre');
            pre.style.whiteSpace = 'pre-wrap';
            pre.style.wordWrap = 'break-word';
            pre.textContent = text;
            
            const container = document.createElement('div');
            container.className = `console-line ${type}`;
            container.innerHTML = `[${time}]`;
            container.appendChild(pre);

            consoleContent.appendChild(container);
            consoleContent.scrollTop = consoleContent.scrollHeight;
        }

        function showAST() {
            if (!editor) return;
            const code = editor.getValue();
            if (!code.trim()) return logToConsole('‚ö†Ô∏è No hay c√≥digo para analizar.', 'warning');
            logToConsole('üå≥ Generando AST...', 'info');
            fetch('/get_ast', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ code: code }),
            })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    if (data.ast_string) {
                        logToConsole('--- CSSX AST ---', 'info');
                        logPreformatted(data.ast_string, 'info');
                        logToConsole('------------------', 'info');
                    }
                }
                else logToConsole(`‚ùå Error al generar AST: ${data.error}`, 'error');
            })
            .catch(err => logToConsole(`‚ùå Error de red: ${err}`, 'error'));
        }

        const resizer = document.getElementById('resizer');
        const consolePanel = document.getElementById('consolePanel');
        const mainContainer = document.getElementById('mainContainer');
        resizer.addEventListener('mousedown', () => {
            document.addEventListener('mousemove', onMouseMove);
            document.addEventListener('mouseup', () => {
                document.removeEventListener('mousemove', onMouseMove);
            }, { once: true });
        });
        function onMouseMove(e) {
            const newHeight = window.innerHeight - e.clientY;
            if (newHeight > 80 && newHeight < window.innerHeight * 0.8) {
                const newHeightStr = `${newHeight}px`;
                consolePanel.style.height = newHeightStr;
                mainContainer.style.height = `calc(100vh - var(--header-height) - var(--toolbar-height) - ${newHeightStr})`;
            }
        }
    </script>
</body>
</html>